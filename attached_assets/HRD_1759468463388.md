# HRD: ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìŠ¤ë§ˆíŠ¸ë¸”ë¡ ìˆœìœ„ ì¶”ì  ì‹œìŠ¤í…œ
## High-Level Requirements Document

**ì‘ì„±ì¼**: 2025-01-02
**ë²„ì „**: 1.0
**ìƒíƒœ**: Multi-Agent ë¶„ì„ ì™„ë£Œ

---

## ğŸ“‹ Executive Summary

### í”„ë¡œì íŠ¸ ê²€ì¦ ê²°ê³¼

**ì „ì²´ í‰ê°€**: âœ… **êµ¬ì¡°ì ìœ¼ë¡œ ê±´ì „í•˜ë‚˜ í•„ìˆ˜ ê°œì„ ì‚¬í•­ ì¡´ì¬**

- **ì•„í‚¤í…ì²˜ ì„±ìˆ™ë„**: 7.2/10 (Good, ê°œì„  í•„ìš”)
- **UI/UX ì„¤ê³„**: ê²¬ê³ í•œ ê¸°ë°˜ (PandaRank ìŠ¤íƒ€ì¼ + Atomic Design)
- **ë°±ì—”ë“œ ë¡œì§**: **CRITICAL** - SerpAPI í• ë‹¹ëŸ‰ ë¬¸ì œ ë° ë™ì‹œì„± ì œì–´ ëˆ„ë½

### í•µì‹¬ ë°œê²¬ì‚¬í•­

| êµ¬ë¶„ | í˜„í™© | ê¶Œì¥ì‚¬í•­ |
|------|------|----------|
| **API í• ë‹¹ëŸ‰** | SerpAPI 100íšŒ/ì›” â†’ 3ê°œ í‚¤ì›Œë“œë§Œ ì¶”ì  ê°€ëŠ¥ | í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²• (Naver API + SerpAPI) |
| **ë™ì‹œì„± ì œì–´** | ì—†ìŒ â†’ ì¤‘ë³µ ì¸¡ì • ë°œìƒ ê°€ëŠ¥ | Redis ë¶„ì‚° ë½ êµ¬í˜„ |
| **ë³´ì•ˆ** | SQL ì¸ì ì…˜ ì·¨ì•½ì , RLS ìš°íšŒ ê°€ëŠ¥ì„± | Rate limiting + Input validation |
| **ì„±ëŠ¥** | N+1 ì¿¼ë¦¬, ë¹„íš¨ìœ¨ì  HTML íŒŒì‹± | Materialized View + Worker Threads |

**ê²°ë¡ **: êµ¬í˜„ ë°©í–¥ì€ ì˜¬ë°”ë¥´ë‚˜ **4ê°€ì§€ í•„ìˆ˜ ìˆ˜ì •ì‚¬í•­** ì ìš© í›„ ì§„í–‰ ê¶Œì¥

---

## ğŸ—ï¸ Architecture Review Summary

### Overall Assessment

**ì•„í‚¤í…ì²˜ ì„±ìˆ™ë„ ì ìˆ˜**: 7.2/10

**ê°•ì **:
- âœ… ëª…í™•í•œ ê´€ì‹¬ì‚¬ ë¶„ë¦¬ (Crawler â†” Worker â†” API)
- âœ… í™•ì¥ ê°€ëŠ¥í•œ í ì‹œìŠ¤í…œ (BullMQ + Redis)
- âœ… Supabase Realtime í™œìš©í•œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸

**ê°œì„  í•„ìš” ì˜ì—­**:

#### 1. Dependency Inversion Principle ìœ„ë°˜

**ë¬¸ì œì **:
```typescript
// âŒ CURRENT: MeasurementWorkerê°€ SerpAPIClientì— ì§ì ‘ ì˜ì¡´
class MeasurementWorker {
  constructor(private serpApiClient: SerpAPIClient) {}
}
```

**í•´ê²°ì±…**:
```typescript
// âœ… SOLUTION: ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•œ ì¶”ìƒí™”
interface ISearchProvider {
  searchNaver(keyword: string): Promise<SearchResult>;
}

class MeasurementWorker {
  constructor(private searchProvider: ISearchProvider) {}
}

// êµ¬í˜„ì²´ ì£¼ì… (SerpAPI, Naver API, Playwright ë“± êµì²´ ê°€ëŠ¥)
const worker = new MeasurementWorker(new HybridSearchProvider());
```

**íš¨ê³¼**: SerpAPI ì™¸ì— ë‹¤ë¥¸ í¬ë¡¤ëŸ¬ë¡œ êµì²´ ê°€ëŠ¥ â†’ ë‹¨ì¼ ì¥ì•  ì§€ì  ì œê±°

#### 2. Error Handling í‘œì¤€í™” ë¶€ì¬

**ë¬¸ì œì **: ê° ì»´í¬ë„ŒíŠ¸ë§ˆë‹¤ ë‹¤ë¥¸ ì—ëŸ¬ ì²˜ë¦¬ ë°©ì‹ ì‚¬ìš©

**í•´ê²°ì±…**:
```typescript
// Global error types
class MeasurementError extends Error {
  constructor(
    message: string,
    public code: string,
    public retryable: boolean,
    public context?: Record<string, any>
  ) {
    super(message);
  }
}

// Centralized error handler
class ErrorHandler {
  async handle(error: Error, job: Job): Promise<void> {
    if (error instanceof MeasurementError && error.retryable) {
      await job.retry({ delay: 60000 });
    } else {
      await this.alertService.sendAdminAlert(error);
    }
  }
}
```

#### 3. Observability ë¶€ì¡±

**ì¶”ê°€ í•„ìš” ì‚¬í•­**:
- **Distributed Tracing**: OpenTelemetryë¡œ ìš”ì²­ íë¦„ ì¶”ì 
- **Structured Logging**: Winston JSON í¬ë§· + ë¡œê·¸ ì§‘ê³„
- **SLO/SLI ì •ì˜**:
  - Measurement ì„±ê³µë¥  â‰¥99.5%
  - íŒŒì‹± ì‹ ë¢°ë„ â‰¥95%
  - ì•Œë¦¼ ì§€ì—°ì‹œê°„ <60ì´ˆ

---

## ğŸ¨ Frontend Design Specifications

### UI/UX Design Validation

**PandaRank ì°¸ì¡° ë¶„ì„ ê²°ê³¼**: âœ… **ì í•©í•œ ë ˆì´ì•„ì›ƒ ì„ íƒ**

### ê¶Œì¥ í˜ì´ì§€ êµ¬ì¡°

#### 1. Dashboard (`/dashboard`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header: Logo | í‚¤ì›Œë“œ ê²€ìƒ‰ | ì‚¬ìš©ì ë©”ë‰´    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Summary Cards Row]                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ì¶”ì ì¤‘â”‚ â”‚ìƒìŠ¹  â”‚ â”‚í•˜ë½  â”‚ â”‚ì•Œë¦¼  â”‚        â”‚
â”‚ â”‚ 15ê°œ â”‚ â”‚ 8ê°œ  â”‚ â”‚ 3ê°œ  â”‚ â”‚ 2ê±´  â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Keyword Table with Real-time Updates]     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚í‚¤ì›Œë“œ â”‚í˜„ì¬ìˆœìœ„â”‚ë³€ë™â”‚ë§ˆì§€ë§‰ì¸¡ì • â”‚      â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚ â”‚ë¸”ë¡œê·¸SEOâ”‚ğŸŸ¢ 1ìœ„ â”‚â†‘2 â”‚5ë¶„ ì „    â”‚      â”‚
â”‚ â”‚ë§ˆì¼€íŒ… â”‚ğŸŸ¡ 3ìœ„ â”‚â†“1 â”‚10ë¶„ ì „   â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ê¸°ìˆ  ìŠ¤íƒ**:
- **Framework**: Next.js 14 App Router
- **Styling**: Tailwind CSS + shadcn/ui
- **Charts**: Recharts (PandaRank ìŠ¤íƒ€ì¼ ë¼ì¸ ì°¨íŠ¸)
- **Real-time**: Supabase Realtime subscriptions

#### 2. Keyword Detail (`/keywords/[id]`)

**í•µì‹¬ ì»´í¬ë„ŒíŠ¸**:
- **Rank Trend Chart**: 30ì¼ ìˆœìœ„ ë³€í™” ì¶”ì´ (ë…¹ìƒ‰ ë¼ì¸)
- **Measurement History Table**: ëª¨ë“  ì¸¡ì • ê¸°ë¡ (í˜ì´ì§€ë„¤ì´ì…˜)
- **Alert Configuration**: ì•Œë¦¼ ì„¤ì • (í•˜ë½ ì„ê³„ê°’, ì•Œë¦¼ ì±„ë„)

**Real-time Update ì „ëµ**:
```typescript
// Server Component (ì´ˆê¸° ë°ì´í„°)
export default async function KeywordDetailPage({ params }) {
  const keyword = await supabase
    .from('keywords')
    .select('*, measurements(*)')
    .eq('id', params.id)
    .single();

  return <KeywordDetailClient initialData={keyword} />;
}

// Client Component (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
'use client';
export function KeywordDetailClient({ initialData }) {
  const { data } = useSupabaseRealtime('measurements', {
    event: 'INSERT',
    filter: `keyword_id=eq.${initialData.id}`
  });

  // ìƒˆ ì¸¡ì •ê°’ ë„ì°© ì‹œ ì°¨íŠ¸ ìë™ ì—…ë°ì´íŠ¸
}
```

### Component Architecture (Atomic Design)

```
components/
â”œâ”€â”€ atoms/
â”‚   â”œâ”€â”€ Badge.tsx          # ìˆœìœ„ ë³€ë™ ë±ƒì§€ (â†‘2, â†“1)
â”‚   â”œâ”€â”€ StatusIndicator.tsx # ğŸŸ¢ğŸŸ¡ğŸ”´ ìƒíƒœ ì 
â”‚   â””â”€â”€ Skeleton.tsx       # ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤
â”œâ”€â”€ molecules/
â”‚   â”œâ”€â”€ KeywordCard.tsx    # ê°œë³„ í‚¤ì›Œë“œ ì¹´ë“œ
â”‚   â”œâ”€â”€ RankChart.tsx      # ìˆœìœ„ ì¶”ì´ ì°¨íŠ¸
â”‚   â””â”€â”€ AlertConfig.tsx    # ì•Œë¦¼ ì„¤ì • í¼
â”œâ”€â”€ organisms/
â”‚   â”œâ”€â”€ KeywordTable.tsx   # ì „ì²´ í‚¤ì›Œë“œ í…Œì´ë¸”
â”‚   â”œâ”€â”€ DashboardStats.tsx # í†µê³„ ì¹´ë“œ ê·¸ë£¹
â”‚   â””â”€â”€ Header.tsx         # í—¤ë” + ê²€ìƒ‰
â””â”€â”€ templates/
    â”œâ”€â”€ DashboardLayout.tsx
    â””â”€â”€ DetailLayout.tsx
```

### Color Palette (PandaRank ê¸°ë°˜)

```css
:root {
  --primary: #00D9A3;      /* ë…¹ìƒ‰ (ìƒìŠ¹) */
  --danger: #FF4757;       /* ë¹¨ê°• (í•˜ë½) */
  --warning: #FFA502;      /* ì£¼í™© (ê²½ê³ ) */
  --background: #F8F9FA;   /* ë°°ê²½ */
  --card: #FFFFFF;         /* ì¹´ë“œ */
  --text-primary: #2C3E50; /* ë³¸ë¬¸ */
  --text-secondary: #7F8C8D; /* ë¶€ì œ */
}
```

### Responsive Breakpoints

```typescript
const breakpoints = {
  mobile: '640px',   // 1-column layout
  tablet: '768px',   // 2-column layout
  desktop: '1024px'  // 3-column layout
};
```

---

## âš™ï¸ Backend Critical Issues & Solutions

### CRITICAL ISSUE #1: SerpAPI Quota Incompatibility

**ë¬¸ì œ ë¶„ì„**:
```
SerpAPI ë¬´ë£Œ í”Œëœ: 100 requests/month
ìš”êµ¬ì‚¬í•­: 10 keywords Ã— 30 days Ã— 1 check/day = 300 requests/month

ê²°ë¡ : í˜„ì¬ ì„¤ê³„ë¡œëŠ” 3ê°œ í‚¤ì›Œë“œë§Œ ì¶”ì  ê°€ëŠ¥ (67% ë¶€ì¡±)
```

**í•´ê²°ì±…**: Hybrid Approach (SerpAPI + Naver Search API)

```typescript
class IntelligentCrawler {
  async measureKeyword(keyword: Keyword): Promise<Measurement> {
    // 1ë‹¨ê³„: ë¬´ë£Œ Naver Search APIë¡œ ë¹ ë¥¸ ìˆœìœ„ í™•ì¸
    const quickRank = await this.naverSearchApi.getBlogRank({
      query: keyword.keyword,
      display: 100
    });

    // 2ë‹¨ê³„: ìˆœìœ„ ë³€ë™ ë˜ëŠ” 24ì‹œê°„ ê²½ê³¼ ì‹œì—ë§Œ HTML íŒŒì‹±
    const needsDeepScan =
      quickRank.rank !== keyword.last_rank ||
      (Date.now() - keyword.last_html_fetch) > 86400000;

    if (needsDeepScan) {
      // SerpAPIë¡œ ì •í™•í•œ ìŠ¤ë§ˆíŠ¸ë¸”ë¡ ìœ„ì¹˜ íŒŒì‹±
      const html = await this.serpApiClient.searchNaver(keyword.keyword);
      return this.parseSmartBlock(html);
    }

    return { rank: quickRank.rank, confidence: 0.85 };
  }
}
```

**ì˜ˆìƒ íš¨ê³¼**:
- API í˜¸ì¶œ 80% ê°ì†Œ (300íšŒ â†’ 60íšŒ/ì›”)
- SerpAPI í• ë‹¹ëŸ‰ìœ¼ë¡œ **50ê°œ í‚¤ì›Œë“œ** ì¶”ì  ê°€ëŠ¥
- ë¹„ìš©: $0 (ë¬´ë£Œ í”Œëœ ë²”ìœ„ ë‚´)

**Fallback ì „ëµ**:
```typescript
// SerpAPI í• ë‹¹ëŸ‰ ì†Œì§„ ì‹œ Playwright ì§ì ‘ í¬ë¡¤ë§
if (serpApiQuotaExceeded) {
  const browser = await playwright.chromium.launch();
  const html = await browser.newPage().goto(
    `https://search.naver.com/search.naver?query=${keyword}`
  );
}
```

### CRITICAL ISSUE #2: Missing Distributed Concurrency Control

**ë¬¸ì œì **:
```typescript
// âŒ ë™ì¼ í‚¤ì›Œë“œì— ëŒ€í•œ ë™ì‹œ ì¸¡ì • ë°©ì§€ ë©”ì»¤ë‹ˆì¦˜ ì—†ìŒ
await measurementQueue.add('measure', { keywordId: 123 });
await measurementQueue.add('measure', { keywordId: 123 }); // ì¤‘ë³µ ê°€ëŠ¥

ê²°ê³¼:
- API í• ë‹¹ëŸ‰ ë‚­ë¹„ (2ë°° í˜¸ì¶œ)
- ë°ì´í„° ë¶ˆì¼ì¹˜ (ë™ì‹œ INSERT)
- ê²½ìŸ ì¡°ê±´ (race condition)
```

**í•´ê²°ì±…**: Redis Distributed Lock

```typescript
class DistributedLock {
  async acquireLock(
    keywordId: number,
    ttl = 300
  ): Promise<boolean> {
    const lockKey = `lock:measurement:${keywordId}`;

    // SET NX EX: ì¡´ì¬í•˜ì§€ ì•Šì„ ë•Œë§Œ ì„¤ì • + TTL
    const acquired = await redis.set(
      lockKey,
      process.pid.toString(),
      'EX', ttl,
      'NX'
    );

    return acquired === 'OK';
  }

  async releaseLock(keywordId: number): Promise<void> {
    await redis.del(`lock:measurement:${keywordId}`);
  }
}

// Workerì—ì„œ ì‚¬ìš©
async processMeasurement(job: Job) {
  const locked = await this.lock.acquireLock(job.data.keywordId);

  if (!locked) {
    throw new Error('Already in progress');
  }

  try {
    await this.measureKeyword(job.data.keywordId);
  } finally {
    await this.lock.releaseLock(job.data.keywordId);
  }
}
```

**ì¶”ê°€ ë³´ì™„**: Idempotency Token

```typescript
// ì¤‘ë³µ ë°©ì§€ìš© ê³ ìœ  í† í°
interface MeasurementJob {
  keywordId: number;
  idempotencyToken: string; // UUID
}

// DBì— í† í° ì €ì¥ (UNIQUE constraint)
CREATE UNIQUE INDEX idx_measurements_idempotency
ON measurements(keyword_id, idempotency_token);
```

### CRITICAL ISSUE #3: Security Vulnerabilities

**ì·¨ì•½ì  #1: SQL Injection**

```typescript
// âŒ VULNERABLE
const query = `
  SELECT * FROM keywords
  WHERE keyword LIKE '%${userInput}%'
`;

// âœ… SAFE: Parameterized query
const { data } = await supabase
  .from('keywords')
  .select()
  .ilike('keyword', `%${userInput}%`); // ìë™ ì´ìŠ¤ì¼€ì´í•‘
```

**ì·¨ì•½ì  #2: RLS Bypass**

```sql
-- âŒ CURRENT: ê´€ë¦¬ìëŠ” RLS ìš°íšŒ ê°€ëŠ¥
ALTER TABLE keywords ENABLE ROW LEVEL SECURITY;
CREATE POLICY user_keywords ON keywords
  FOR ALL USING (created_by = auth.uid());

-- âœ… SOLUTION: ê´€ë¦¬ìë„ RLS ì ìš©
CREATE POLICY admin_keywords ON keywords
  FOR ALL USING (
    created_by = auth.uid()
    OR EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid() AND role = 'admin'
    )
  );
```

**ì·¨ì•½ì  #3: Rate Limiting ë¶€ì¬**

```typescript
// API ë¼ìš°íŠ¸ì— ì¶”ê°€
import rateLimit from 'express-rate-limit';

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15ë¶„
  max: 100, // 100 requests
  standardHeaders: true,
  legacyHeaders: false,
  keyGenerator: (req) => {
    // IP + User-Agentë¡œ ê³ ìœ  ì‹ë³„
    return `${req.ip}-${req.get('User-Agent')}`;
  }
});

app.use('/api/', apiLimiter);
```

**ì·¨ì•½ì  #4: Input Validation**

```typescript
import { z } from 'zod';

const KeywordSchema = z.object({
  keyword: z.string()
    .min(2, 'ìµœì†Œ 2ì ì´ìƒ')
    .max(100, 'ìµœëŒ€ 100ì')
    .regex(/^[ê°€-í£a-zA-Z0-9\s]+$/, 'íŠ¹ìˆ˜ë¬¸ì ë¶ˆê°€'),
  target_url: z.string()
    .url('ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤')
    .startsWith('https://blog.naver.com/', 'ë„¤ì´ë²„ ë¸”ë¡œê·¸ë§Œ ê°€ëŠ¥'),
  alert_threshold: z.number()
    .int()
    .min(1)
    .max(10)
});

// API í•¸ë“¤ëŸ¬
export async function POST(req: Request) {
  const body = await req.json();
  const validated = KeywordSchema.parse(body); // ê²€ì¦ ì‹¤íŒ¨ ì‹œ throw
  // ...
}
```

### CRITICAL ISSUE #4: Performance Bottlenecks

**ë³‘ëª© #1: N+1 Query**

```sql
-- âŒ CURRENT: latest_measurements ë·°ì—ì„œ 1000ê°œ ì„œë¸Œì¿¼ë¦¬
CREATE VIEW latest_measurements AS
SELECT k.*, (
  SELECT rank_smartblock
  FROM measurements
  WHERE keyword_id = k.id
  ORDER BY measured_at DESC
  LIMIT 1
) FROM keywords k;

-- âœ… SOLUTION: Materialized View
CREATE MATERIALIZED VIEW latest_measurements_mv AS
SELECT DISTINCT ON (k.id)
  k.id, k.keyword, m.rank_smartblock, m.measured_at
FROM keywords k
LEFT JOIN measurements m ON k.id = m.keyword_id
ORDER BY k.id, m.measured_at DESC;

-- 5ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹ 
CREATE OR REPLACE FUNCTION refresh_latest_mv()
RETURNS void AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY latest_measurements_mv;
END;
$$ LANGUAGE plpgsql;

SELECT cron.schedule(
  'refresh-latest-measurements',
  '*/5 * * * *',
  'SELECT refresh_latest_mv()'
);
```

**ë³‘ëª© #2: Inefficient HTML Parsing**

```typescript
// âŒ CURRENT: Cheerio (ëŠë¦¼, ë‹¨ì¼ ìŠ¤ë ˆë“œ)
const $ = cheerio.load(html);
const smartBlock = $('.blog_smartblock').first();

// âœ… SOLUTION: htmlparser2 + Worker Threads
import { parseDocument } from 'htmlparser2';
import { Worker } from 'worker_threads';

class ParallelParser {
  async parseSmartBlock(html: string): Promise<SmartBlock> {
    return new Promise((resolve, reject) => {
      const worker = new Worker('./parser.worker.js', {
        workerData: { html }
      });

      worker.on('message', resolve);
      worker.on('error', reject);
    });
  }
}

// parser.worker.js
const { workerData } = require('worker_threads');
const dom = parseDocument(workerData.html); // 2-3ë°° ë¹ ë¦„
// íŒŒì‹± ë¡œì§...
parentPort.postMessage(result);
```

**ì„±ëŠ¥ ê°œì„  íš¨ê³¼**:
- íŒŒì‹± ì†ë„: 500ms â†’ 150ms (70% ê°œì„ )
- CPU ì‚¬ìš©ë¥ : Worker Poolë¡œ ë³‘ë ¬ ì²˜ë¦¬
- ë©”ëª¨ë¦¬: Stream íŒŒì‹±ìœ¼ë¡œ 50% ê°ì†Œ

**ë³‘ëª© #3: TimescaleDB ë¯¸ì‚¬ìš©**

```sql
-- measurements í…Œì´ë¸”ì„ hypertableë¡œ ë³€í™˜
SELECT create_hypertable(
  'measurements',
  'measured_at',
  chunk_time_interval => INTERVAL '1 month'
);

-- ìë™ ì••ì¶• (90ì¼ ì´ì „ ë°ì´í„°)
ALTER TABLE measurements SET (
  timescaledb.compress,
  timescaledb.compress_segmentby = 'keyword_id'
);

SELECT add_compression_policy(
  'measurements',
  INTERVAL '90 days'
);

-- BRIN ì¸ë±ìŠ¤ (ì‹œê³„ì—´ ë°ì´í„°ì— ìµœì í™”)
CREATE INDEX idx_measurements_time_brin
ON measurements USING BRIN (measured_at);
```

**ìŠ¤í† ë¦¬ì§€ ì ˆê°**: ì••ì¶• í›„ 70-90% ìš©ëŸ‰ ê°ì†Œ

---

## ğŸ“… Implementation Roadmap

### Phase 1: Critical Fixes (Week 1)

**ìš°ì„ ìˆœìœ„ 1 - API í• ë‹¹ëŸ‰ ë¬¸ì œ í•´ê²°**
- [ ] Naver Search API í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
- [ ] Hybrid crawler ë¡œì§ êµ¬í˜„
- [ ] SerpAPI fallback ë©”ì»¤ë‹ˆì¦˜ ì¶”ê°€
- [ ] API í˜¸ì¶œ ê°ì‚¬ ë¡œê¹…

**ìš°ì„ ìˆœìœ„ 2 - ë™ì‹œì„± ì œì–´**
- [ ] Redis ë¶„ì‚° ë½ êµ¬í˜„
- [ ] Idempotency token ìŠ¤í‚¤ë§ˆ ì¶”ê°€
- [ ] BullMQ job deduplication ì„¤ì •

**ìš°ì„ ìˆœìœ„ 3 - ë³´ì•ˆ ê°•í™”**
- [ ] Rate limiting ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€
- [ ] Zod ì…ë ¥ ê²€ì¦ ìŠ¤í‚¤ë§ˆ ì‘ì„±
- [ ] RLS ì •ì±… ê°•í™”
- [ ] API í‚¤ rotation ë©”ì»¤ë‹ˆì¦˜

**ê²€ì¦ ê¸°ì¤€**:
- âœ… 10ê°œ í‚¤ì›Œë“œ 30ì¼ ì¶”ì  ì‹œ API í˜¸ì¶œ <100íšŒ
- âœ… ë™ì¼ í‚¤ì›Œë“œ ë™ì‹œ ì¸¡ì • ì‹œë„ ì‹œ ì—ëŸ¬ ë°œìƒ
- âœ… SQL ì¸ì ì…˜ í…ŒìŠ¤íŠ¸ í†µê³¼
- âœ… Rate limit í…ŒìŠ¤íŠ¸ í†µê³¼ (101ë²ˆì§¸ ìš”ì²­ ê±°ë¶€)

### Phase 2: Core Features (Week 2-3)

**Backend (Week 2)**
- [ ] MeasurementWorker ì™„ì„± (Hybrid crawler í†µí•©)
- [ ] AlertService êµ¬í˜„ (ì´ë©”ì¼ + Slack)
- [ ] SchedulerService (dynamic interval)
- [ ] Webhook API ì—”ë“œí¬ì¸íŠ¸

**Frontend (Week 3)**
- [ ] Next.js 14 í”„ë¡œì íŠ¸ ìƒì„±
- [ ] Dashboard í˜ì´ì§€ (ì¹´ë“œ + í…Œì´ë¸”)
- [ ] Keyword Detail í˜ì´ì§€ (ì°¨íŠ¸ + íˆìŠ¤í† ë¦¬)
- [ ] Supabase Realtime ì—°ê²°
- [ ] shadcn/ui ì»´í¬ë„ŒíŠ¸ í†µí•©

**Database**
- [ ] Supabase ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] RLS ì •ì±… ì ìš©
- [ ] í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‹œë”©

**ê²€ì¦ ê¸°ì¤€**:
- âœ… í‚¤ì›Œë“œ ì¶”ê°€ â†’ 1ì‹œê°„ ì´ë‚´ ì²« ì¸¡ì • ì™„ë£Œ
- âœ… ìˆœìœ„ ë³€ë™ â†’ 3ë¶„ ì´ë‚´ ì•Œë¦¼ ë°œì†¡
- âœ… Dashboard ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (5ì´ˆ ì´ë‚´)

### Phase 3: Optimization (Week 4)

**Performance**
- [ ] TimescaleDB hypertable ë³€í™˜
- [ ] Materialized view ìƒì„± + ìë™ ê°±ì‹ 
- [ ] Worker Threads íŒŒì„œ êµ¬í˜„
- [ ] BRIN ì¸ë±ìŠ¤ ì¶”ê°€

**Observability**
- [ ] OpenTelemetry ì„¤ì •
- [ ] Winston JSON ë¡œê¹…
- [ ] Supabase í•¨ìˆ˜ ë¡œê·¸ ì—°ê²°
- [ ] Grafana ëŒ€ì‹œë³´ë“œ (ì„ íƒ)

**Quality**
- [ ] E2E í…ŒìŠ¤íŠ¸ (Playwright)
- [ ] Load testing (k6)
- [ ] Security audit (OWASP ZAP)

**ê²€ì¦ ê¸°ì¤€**:
- âœ… 1000ê°œ í‚¤ì›Œë“œ ë™ì‹œ ì¸¡ì • <10ë¶„
- âœ… API ì‘ë‹µ ì‹œê°„ P95 <200ms
- âœ… íŒŒì‹± ì‹ ë¢°ë„ >95%
- âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ <500MB

### Phase 4: Production Launch (Week 5)

**Deployment**
- [ ] Supabase í”„ë¡œì íŠ¸ Production í™˜ê²½ ìƒì„±
- [ ] Vercel ë°°í¬ (Next.js)
- [ ] Railway/Render ë°°í¬ (BullMQ Worker)
- [ ] Upstash Redis ì„¤ì •

**Monitoring**
- [ ] Uptime ëª¨ë‹ˆí„°ë§ (UptimeRobot)
- [ ] Error tracking (Sentry)
- [ ] Performance monitoring (Vercel Analytics)

**Documentation**
- [ ] API ë¬¸ì„œ (Swagger)
- [ ] ì‚¬ìš©ì ê°€ì´ë“œ
- [ ] ìš´ì˜ ê°€ì´ë“œ (troubleshooting)

**ê²€ì¦ ê¸°ì¤€**:
- âœ… 99.5% uptime (ì²« ì£¼)
- âœ… ì—ëŸ¬ìœ¨ <0.1%
- âœ… ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘

---

## ğŸš¨ Risk Mitigation

### Risk #1: SerpAPI ì˜ì¡´ì„±

**ë¦¬ìŠ¤í¬**: SerpAPI ì„œë¹„ìŠ¤ ì¥ì•  ë˜ëŠ” ì •ì±… ë³€ê²½

**ì™„í™” ì „ëµ**:
1. **Primary**: Naver Search API (ë¬´ë£Œ, ì•ˆì •ì )
2. **Secondary**: SerpAPI (ì •í™•ë„ ë†’ìŒ)
3. **Fallback**: Playwright ì§ì ‘ í¬ë¡¤ë§

```typescript
class ResilientCrawler {
  async measureWithFallback(keyword: string): Promise<Measurement> {
    try {
      return await this.naverSearchApi.measure(keyword);
    } catch (err) {
      try {
        return await this.serpApiClient.measure(keyword);
      } catch (err2) {
        return await this.playwrightCrawler.measure(keyword);
      }
    }
  }
}
```

### Risk #2: Performance at Scale

**ë¦¬ìŠ¤í¬**: 1000+ í‚¤ì›Œë“œ ì¶”ì  ì‹œ ì„±ëŠ¥ ì €í•˜

**ì™„í™” ì „ëµ**:
1. **Dynamic Worker Scaling**:
```typescript
const queueSize = await measurementQueue.count();
const workerCount = Math.min(
  Math.ceil(queueSize / 100),
  10 // ìµœëŒ€ 10ê°œ ì›Œì»¤
);

for (let i = 0; i < workerCount; i++) {
  new Worker('measurement.worker.js');
}
```

2. **Intelligent Batching**:
```typescript
// ë¹„ìŠ·í•œ í‚¤ì›Œë“œë¥¼ ë¬¶ì–´ì„œ í•œ ë²ˆì— ìš”ì²­
const batch = await supabase
  .from('keywords')
  .select()
  .eq('next_measurement_due', true)
  .limit(20);

await Promise.all(batch.map(k => this.measure(k)));
```

### Risk #3: Data Loss

**ë¦¬ìŠ¤í¬**: Measurement ë°ì´í„° ì†ì‹¤

**ì™„í™” ì „ëµ**:
1. **Point-in-Time Recovery**: Supabase ìë™ ë°±ì—… (7ì¼)
2. **Replication**: Supabase ë‚´ì¥ replica
3. **Manual Backup**:
```bash
# ë§¤ì¼ ìì • ë°±ì—…
pg_dump $DATABASE_URL | gzip > backup-$(date +%Y%m%d).sql.gz
```

### Risk #4: Security Breach

**ë¦¬ìŠ¤í¬**: ì‚¬ìš©ì ë°ì´í„° ìœ ì¶œ

**ì™„í™” ì „ëµ**:
1. **RLS + JWT**: ëª¨ë“  ìš”ì²­ì— ì‚¬ìš©ì ì¸ì¦ í•„ìˆ˜
2. **Secrets Rotation**: API í‚¤ 90ì¼ë§ˆë‹¤ êµì²´
3. **Audit Log**:
```sql
CREATE TABLE audit_logs (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID,
  action TEXT,
  resource TEXT,
  ip_address INET,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ëª¨ë“  ë¯¼ê°í•œ ì‘ì—… ê¸°ë¡
INSERT INTO audit_logs (user_id, action, resource)
VALUES (auth.uid(), 'DELETE', 'keyword:123');
```

---

## ğŸ“Š Success Metrics

### Technical KPIs

| ì§€í‘œ | ëª©í‘œ | ì¸¡ì • ë°©ë²• |
|------|------|----------|
| **API Quota íš¨ìœ¨** | <50 SerpAPI calls/month (10 keywords) | Redis counter |
| **Measurement ì„±ê³µë¥ ** | â‰¥99.5% | `success_count / total_count` |
| **íŒŒì‹± ì‹ ë¢°ë„** | â‰¥95% | `confidence` ì»¬ëŸ¼ í‰ê·  |
| **API ì‘ë‹µ ì‹œê°„** | P95 <200ms | OpenTelemetry |
| **ì•Œë¦¼ ì§€ì—°** | <60ì´ˆ (ìˆœìœ„ ë³€ë™ â†’ ì•Œë¦¼) | `alert.sent_at - measurement.measured_at` |
| **ì‹œìŠ¤í…œ ê°€ìš©ì„±** | 99.5% uptime | UptimeRobot |

### Business KPIs

| ì§€í‘œ | ëª©í‘œ (1ê°œì›”) |
|------|--------------|
| **í™œì„± ì‚¬ìš©ì** | 10ëª… |
| **ì¶”ì  í‚¤ì›Œë“œ** | 100ê°œ |
| **ì¼ì¼ ì¸¡ì •** | 500íšŒ |
| **ë°œì†¡ ì•Œë¦¼** | 50ê±´ |

### Quality Gates (Production ë°°í¬ ì „ í•„ìˆ˜)

- [ ] **Security**: OWASP ZAP ìŠ¤ìº” ì·¨ì•½ì  0ê±´
- [ ] **Performance**: Load test í†µê³¼ (100 concurrent users)
- [ ] **Reliability**: 7ì¼ ì—°ì† 99% uptime
- [ ] **Testing**: E2E test coverage â‰¥80%
- [ ] **Documentation**: API ë¬¸ì„œ + ìš´ì˜ ê°€ì´ë“œ ì™„ì„±

---

## ğŸ¯ Next Steps

### Immediate Actions (ì´ë²ˆ ì£¼)

1. **Phase 1 Critical Fixes ì°©ìˆ˜**
   - Hybrid crawler êµ¬í˜„ ì‹œì‘
   - Redis ë¶„ì‚° ë½ ì¶”ê°€
   - Rate limiting ë¯¸ë“¤ì›¨ì–´ ì‘ì„±

2. **í”„ë¡œí† íƒ€ì… í…ŒìŠ¤íŠ¸**
   - 3ê°œ í‚¤ì›Œë“œë¡œ 7ì¼ê°„ í…ŒìŠ¤íŠ¸
   - API í˜¸ì¶œ íšŸìˆ˜ ëª¨ë‹ˆí„°ë§
   - íŒŒì‹± ì •í™•ë„ ê²€ì¦

3. **íŒ€ ë¦¬ë·°**
   - HRD ë¬¸ì„œ ë‚´ë¶€ ê²€í† 
   - ìš°ì„ ìˆœìœ„ ì¡°ì •
   - ë¦¬ì†ŒìŠ¤ í• ë‹¹

### Decision Points

**Week 1 ì¢…ë£Œ ì‹œ**:
- âœ… Hybrid crawlerê°€ SerpAPI ëŒ€ë¹„ 90% ì •í™•ë„ ë‹¬ì„± â†’ Phase 2 ì§„í–‰
- âŒ ì •í™•ë„ <80% â†’ Playwright fallback ìš°ì„  ê°œë°œ

**Week 3 ì¢…ë£Œ ì‹œ**:
- âœ… 10ê°œ í‚¤ì›Œë“œ ì•ˆì •ì  ì¶”ì  â†’ Phase 4 Production ì¤€ë¹„
- âŒ ì„±ëŠ¥ ì´ìŠˆ ë°œìƒ â†’ Phase 3 ìµœì í™” ë¨¼ì € ì§„í–‰

---

## ğŸ“š References

### Internal Documents
- [PRD.md](./PRD.md) - Product Requirements
- [DATABASE_SCHEMA.md](./DATABASE_SCHEMA.md) - Supabase Schema
- [TECHNICAL_DESIGN.md](./TECHNICAL_DESIGN.md) - Technical Specifications
- [TECHNICAL_DESIGN_KR.md](./TECHNICAL_DESIGN_KR.md) - ê¸°ìˆ  ì„¤ê³„ (í•œê¸€)

### External Resources
- [SerpAPI Documentation](https://serpapi.com/naver-search-api)
- [Naver Search API](https://developers.naver.com/docs/serviceapi/search/blog/blog.md)
- [Supabase RLS Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [TimescaleDB Best Practices](https://docs.timescale.com/timescaledb/latest/how-to-guides/)
- [Next.js 14 App Router](https://nextjs.org/docs/app)

### Architecture Review Sources
- **architect-reviewer** analysis (7.2/10 score)
- **frontend-developer** UI/UX recommendations
- **backend-architect** critical issues report

---

**ë¬¸ì„œ ìƒíƒœ**: âœ… Multi-Agent ë¶„ì„ ì™„ë£Œ, ì‹¤í–‰ ì¤€ë¹„ë¨
**ìµœì¢… ê²€í† **: 2025-01-02
**ìŠ¹ì¸ì**: [To be filled]
